#* @apiTitle Plumber API for generating PDFs

library(stringr)
options(scipen = 999, tinytex.verbose = TRUE, Encoding="UTF-8", max.print=100))
knitr::opts_chunk$set(echo = F,message=F,warning=F,cache = F)
file_name <- paste0('unsigned', ".pdf")


#* Print to log
#* @filter logger
logger = function(req){
  cat("\n", as.character(Sys.time()), 
      "\n", req$REQUEST_METHOD, req$PATH_INFO, 
      "\n", req$HTTP_USER_AGENT, "@", req$REMOTE_ADDR)
  plumber::forward()
}

  

#* @assets ./files/static
list()




#* @serializer contentType list(type="application/pdf")
#* @description Gets PDF
#* @param id The id of generation (id)
#* @get /pdf
function(id, res){
  output_dir <- file.path(".",id)
  output_file_path <- file.path(output_dir, file_name)
  if (path.exists(output_file_path)){
    readBin(output_file_path, "raw", n=file.info(output_file_path)$size)
  }
  else{
    res$status <- 404
    return(list(error="Not Found"))
  }
}


#* @description Gets metadata for rmarkdown
#* @get /meta
function(res){
  y <- yaml.load("rmarkdown.yaml")
  return (y)
}



#* @serializer contentType list(type="application/pdf")
#* @description Generates PDF
#* @post /pdf
function(req){

  params = jsonlite::fromJSON(req$postBody)
  output_dir <- file.path(".",id)
  output_file_path <- file.path(output_dir, file_name)
  
  file.create(file.path(output_dir, "start"))
  rmarkdown::render("rmarkdown.Rmd", output_dir=output_dir, output_format="pdf_document", output_file=file_name,
         params = params, envir = new.env())
  
  file.create(file.path(output_dir, "done"))
  
  readBin(output_file_path, "raw", n=file.info(output_file_path)$size)
}


#* @description will remove old working folder 
#* @delete /pdf
#* @param numberOfHours After number of hours, old generation will be removed 
function(numberOfHours) {
  dirs_to_check <- list.dirs( recursive = FALSE)
  removed_dirs <- c()
  for (dir_to_check in dirs_to_check) {
    if(str_starts(dir_to_check, ".", negate = TRUE))
    {
      
      gen_start <- file.mtime(file.path(dir_to_check, "start"))
      if(difftime(Sys.time(), gen_start,  units = "hours") > numberOfDays) {
        unlink(dir_to_check, recursive = TRUE, force = TRUE)
        removed_dirs <- c(removed_dirs, dir_to_check)
      }
    }
  }
  return(removed_dirs)
}

#* @head /test 
function() {
  return("OK")
}
